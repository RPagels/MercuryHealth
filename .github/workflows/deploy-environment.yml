name: Deployment Environment

on:
  workflow_call:
    inputs:
      resource-group-base-name:
        description: 'Resource Group base name'
        default: 'rg-mercuryhealth-dev'
        required: true
        type: string
      environment-suffix:
        description: 'The suffix to be used for the current environment'
        default: 'dev'
        required: true
        type: string
      resource-group-location:
        description: 'Azure region for the deployed resources'
        default: 'eastus'
        required: false
        type: string
    secrets:
      azure-credentials:
        description: 'Credentials used to log into Azure for deployment of resources'
        required: true
      sql-db-server-name:
        description: 'Credentials used to log into SQL for deployment of resources'
        required: true
      sql-db-login:
        description: 'Credentials used to log into SQL for deployment of resources'
        required: true
      sql-db-password:
        description: 'Credentials used to log into SQL for deployment of resources'
        required: true
      sql-connection-string:
        description: 'Credentials used to log into SQL for deployment of resources'
        required: true

jobs:
  ###################################################################
  # Deployment Stage - Infrastructure / Application / Database      #
  ###################################################################
  deploy_to_environment:
    runs-on: ubuntu-latest
    name: Build Application
    env:
      Azure_Resource_GroupName: ${{ inputs.resource-group-base-name }}-${{ inputs.environment-suffix }}
      #Azure_ReleaseAnnotationName: 'temp-deployment'
      webAppUrl: 'TBD'

    permissions:
      contents: read
      packages: write

    # Identify any jobs that must complete successfully before this job will run.
    steps:
    - name: Login to Azure
      uses: azure/login@v1
      continue-on-error: false
      with:
        creds: ${{ secrets.azure-credentials }}

    - name: Ensure Resource Group Exists
      uses: Azure/CLI@v1
      with:
        inlineScript: |
          #!/bin/bash
          az group create --name ${{ env.Azure_Resource_GroupName }} --location ${{ inputs.resource-group-location }}

# ERROR!!!
# The client '53173f83-e7b7-462c-9a4e-adb64374ebed' with object id '53173f83-e7b7-462c-9a4e-adb64374ebed' does not have authorization to perform action 'Microsoft.Resources/subscriptions/resourcegroups/write' over scope '/subscriptions/***/resourcegroups/rg-MercuryHealth-dev' or the scope is invalid. If access was recently granted, please refresh your credentials.
#
#    - name: Ensure Resource Group is Locked
#      if: contains(github.event_name, 'push')
#      uses: Azure/CLI@v1
#      continue-on-error: false
#      with:
#        inlineScript: |
#          az group lock create --lock-type ReadOnly -n 'DontDeleteMe' -g ${{ env.Azure_Resource_GroupName }} -n 'Prevent deletion of the resource group'

    - name: Download Build Artifact-Infrastructure
      uses: actions/download-artifact@v2
      continue-on-error: false
      with:
        name: MercuryHealth.IaC
        path: ${{ github.workspace }}/MercuryHealth.IaC

#      ###########################################
#      # Validate ARM Template using Bicep DSL
#      ###########################################
#    - name: Validate Azure Bicep
#      uses: azure/arm-deploy@v1
#      continue-on-error: false
#      with:
#        resourceGroupName: ${{ env.Azure_Resource_GroupName }}
#        template: ./MercuryHealth.IaC/main-1.bicep
#        parameters: ./MercuryHealth.IaC/main-1.params.json sqlAdministratorLogin=${{ secrets.sql-db-login }} sqlAdministratorLoginPassword=${{ secrets.sql-db-password }}
#        deploymentMode: Validate
        
      ###########################################
      # Deploy ARM Template using Bicep DSL
      ###########################################
    - name: Infrastructure
      id: Infra
      uses: azure/arm-deploy@v1
      continue-on-error: false
      with:
        resourceGroupName: ${{ env.Azure_Resource_GroupName }}
        template: ./MercuryHealth.IaC/main-1.bicep
        parameters: ./MercuryHealth.IaC/main-1.params.json sqlAdministratorLogin=${{ secrets.sql-db-login }} sqlAdministratorLoginPassword=${{ secrets.sql-db-password }}
        deploymentMode: Incremental
        failOnStdErr: false

    - name: Save Application Insights Id to Environment Variable
      run: |
         echo 'sqlserverFQName = ${{steps.Infra.outputs.out_sqlserverFQName}}'
#        echo 'webSiteName = ${{steps.Infra.outputs.out_webSiteName}}'
#        echo 'functionAppName = ${{steps.Infra.outputs.out_functionAppName}}'
#        echo 'sqlserverName = ${{steps.Infra.outputs.out_sqlserverName}}'
#        echo 'sqlDBName = ${{steps.Infra.outputs.out_sqlDBName}}'
#        echo 'sqlConnectionString = ${{steps.Infra.outputs.out_sqlConnectionString}}
#        echo 'configStoreName = ${{steps.Infra.outputs.out_configStoreName}}'
#        echo 'appInsightsName = ${{steps.Infra.outputs.out_appInsightsName}}'
#        echo 'apiServiceName = ${{steps.Infra.outputs.out_apiServiceName}}'
#        echo 'loadTestsName = ${{steps.Infra.outputs.out_loadTestsName}}'
#        echo 'keyvaultName = ${{steps.Infra.outputs.out_keyvaultName}}'
#        echo 'appInsightsApplicationId = ${{steps.Infra.outputs.out_appInsightsApplicationId}}'
#        echo ''
#        echo "::set-output name=appInsightsAppId2::${{steps.Infra.outputs.out_appInsightsApplicationId}}"
#        echo "appInsightsAppId3= ${{ steps.Infra.outputs.out_appInsightsApplicationId }}" >> $GITHUB_ENV

    - name: Download Build Artifact-Database
      uses: actions/download-artifact@v2
      continue-on-error: false
      with:
        name: MercuryHealth.Database
        path: ${{ github.workspace }}/MercuryHealth.Database
        
    # Deploy Database *.dacpac file - Requires windows-latest runner!!!
    - name: 'Deploy the database to Azure'
      uses: Azure/sql-action@v1.2
      with:
        server-name: ${{ steps.Infra.outputs.out_sqlserverFQName }}
        connection-string: ${{â€¯secrets.sql-connection-string }}
        dacpac-package: './MercuryHealth.Database/MercuryHealth.Database.dacpac'

    - name: Download Build Artifacts-Website Applicationn
      uses: actions/download-artifact@v2
      continue-on-error: false
      with:
        name: MercuryHealth.Website
        path: ${{ github.workspace }}/MercuryHealth.Website

    - name: 'Deploy Website Application'
      uses: azure/webapps-deploy@v2
      with:
          app-name: ${{ steps.Infra.outputs.out_webSiteName }}
          #slot-name: 'Dev'
          package: './MercuryHealth.Website'
          
    - name: Download Build Artifacts-Function Application
      uses: actions/download-artifact@v2
      continue-on-error: false
      with:
        name: MercuryHealth.FunctionApp
        path: ${{ github.workspace }}/MercuryHealth.FunctionApp

    # Deploy Function Application
    - name: 'Deploy Function Application'
      uses: Azure/functions-action@v1
      with:
        app-name: ${{ steps.Infra.outputs.out_functionAppName }}
        slot-name: 'production'
        package: './MercuryHealth.FunctionApp'

# --api-key ${{ steps.Infra.outputs.releaseAnnotationId }}
    - name: Generate Temporary API Key For App Insights
      id: AIKeyGen
      uses: Azure/CLI@v1
      with:
        inlineScript: |
          az config set extension.use_dynamic_install=yes_without_prompt
          result=$(az monitor app-insights api-key create \
                      --api-key ${{ steps.Infra.outputs.out_releaseAnnotationGuidID }} \
                      --write-properties WriteAnnotations \
                      -g ${{ env.Azure_Resource_GroupName }} \
                      --app ${{ steps.Infra.outputs.out_appInsightsApplicationId }} \
                      --query "apiKey" --output tsv)
          echo "::set-output name=aiKey::$result"
    
    - name: Consume AI Key For App Insights
      run: |
        echo 'out_releaseAnnotationGuidID=${{ steps.Infra.outputs.out_releaseAnnotationGuidID }}'
        echo 'out_appInsightsApplicationId=${{ steps.Infra.outputs.out_appInsightsApplicationId }}'
        echo 'out_appInsightsAPIApplicationId=${{ steps.Infra.outputs.out_appInsightsAPIApplicationId }}'
        echo 'steps.AIKeyGen.outputs.aiKey=${{ steps.AIKeyGen.outputs.aiKey }}'
        
    - name: Annotate deployment
      uses: wictorwilen/application-insights-action@v1
      id: annotation
      with:
        applicationId: ${{ steps.Infra.outputs.out_appInsightsAPIApplicationId }}
        apiKey: ${{ steps.AIKeyGen.outputs.aiKey }}
        releaseName: ${{ github.event_name }}
        message: ${{ github.event.head_commit.message }}
        actor: ${{ github.actor }}

# --api-key ${{ steps.Infra.outputs.releaseAnnotationId }}
    - name: Remove Temporary API Key For App Insights
      uses: Azure/CLI@v1
      with:
        inlineScript: |
          az config set extension.use_dynamic_install=yes_without_prompt
          az monitor app-insights api-key delete \
                      --api-key ${{ steps.Infra.outputs.out_releaseAnnotationGuidID }} \
                      -g ${{ env.Azure_Resource_GroupName }} \
                      --app ${{ steps.Infra.outputs.out_appInsightsApplicationId }} 

###################################################################
# CD Stage - UI Testing                         
###################################################################
  UITesting_Stage_ApplicationOnChromium:
    if: contains(github.event_name, 'push')

    name: Playwright Tests on Chromium
    
    # The type of runner that the job will run on
    runs-on: windows-latest

    # Identify any jobs that must complete successfully before this job will run.
    needs: [deploy_to_environment]
    timeout-minutes: 10
        
    steps:
      # Download Artifacts under $GITHUB_WORKSPACE, so your job can access it
      - name: Download Build Artifacts-Playwright Tests
        continue-on-error: false
        uses: actions/download-artifact@v2
        with:
          name: MercuryHealth.UITests
          path: ${{ github.workspace }}/MercuryHealth.UITests

      - name: Playwright Tests
        continue-on-error: false
        run: dotnet test MercuryHealth.UITests/MercuryHealth.UITests.dll --filter TestCategory=Playwright_Tests_Chromium -l "console;verbosity=normal"  --settings MercuryHealth.UITests/MercuryHealthTests.runsettings

###################################################################
# CD Stage - UI Testing                         
###################################################################
  UITesting_Stage_ApplicationOnFireFox:
    if: contains(github.event_name, 'push')

    name: Playwright Tests on FireFox
    
    # The type of runner that the job will run on
    runs-on: windows-latest

    # Identify any jobs that must complete successfully before this job will run.
    needs: [deploy_to_environment]
    timeout-minutes: 10
        
    steps:
      # Download Artifacts under $GITHUB_WORKSPACE, so your job can access it
      - name: Download Build Artifacts-Playwright Tests
        continue-on-error: false
        uses: actions/download-artifact@v2
        with:
          name: MercuryHealth.UITests
          path: ${{ github.workspace }}/MercuryHealth.UITests

      - name: Playwright Tests
        continue-on-error: false
        run: dotnet test MercuryHealth.UITests/MercuryHealth.UITests.dll --filter TestCategory=Playwright_Tests_FireFox -l "console;verbosity=normal" --settings MercuryHealth.UITests/MercuryHealthTests.runsettings

##################################################################
# CD Stage - Load and Performance Testing                         #
###################################################################
  LoadTesting_Stage_Application:
    if: contains(github.event_name, 'push')

    name: Load Test Application
    
    env:
      load_Test_Resource: 'https://app-xibwnqufj5jam.azurewebsites.net'
      load_Test_Resource2: ${{ steps.Infra.outputs.out_loadTestsName }}
      
    # Identify any jobs that must complete successfully before this job will run.
    runs-on: ubuntu-latest

    # Identify any jobs that must complete successfully before this job will run.
    needs: [deploy_to_environment]
    steps:
      - name: Checkout GitHub Actions 
        uses: actions/checkout@v2

      # Download Artifacts under $GITHUB_WORKSPACE, so your job can access it
      - name: Download Build Artifacts-Load Tests
        uses: actions/download-artifact@v2
        with:
          name: MercuryHealth.LoadTests
          path: ${{ github.workspace }}/MercuryHealth.LoadTests
          
      - name: Login to Azure
        uses: azure/login@v1
        continue-on-error: false
        with:
          creds: ${{ secrets.azure-credentials }}

      - name: Set Environment Variable
        run: |
          echo '::set-output name=webAppUrl::${{ steps.Infra.outputs.out_webSiteName }}'
          echo 'webAppUrl= ${{ steps.Infra.outputs.out_webSiteName }}' >> $GITHUB_ENV

      # Use environment variables in Apache JMeter Load Tests - webAppUrl
      # JMX file uses  ${System.getenv("webAppUrl")}

# loadTestResource: ${{ env.Load_Test_Resource }}
# loadTestResource: ${{ steps.Infra.outputs.out_loadTestsName }}
      - name: 'Azure Load Testing'
        uses: azure/load-testing@v1
        continue-on-error: true
        with:
          loadTestConfigFile: './MercuryHealth.LoadTests/LoadTest_HomePage_Config.yaml'
          loadTestResource: ${{ env.Load_Test_Resource }}
          resourceGroup: ${{ env.Azure_Resource_GroupName }}

      - name: Azure logout
        run: |
          az logout
          
###################################################################
# CD Stage - Dev                        #
###################################################################
  Dev_Stage_Application:
    if: contains(github.event_name, 'push')

    name: Deploy to Dev
    
    # Identify any jobs that must complete successfully before this job will run.
    runs-on: ubuntu-latest

    # Identify any jobs that must complete successfully before this job will run.
    needs: [UITesting_Stage_ApplicationOnChromium, UITesting_Stage_ApplicationOnFireFox]
    environment: Dev
    steps:
      - name: Approve Dev Deployment
        run: |
          echo 'Wait for Approval'
