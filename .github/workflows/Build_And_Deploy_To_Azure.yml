# This is a basic workflow to help you get started with Actions

name: Build_And_Deploy_To_Azure

###################################################################
# Environment Variables
###################################################################
env:
  # Path to the solution file relative to the root of the project.
  buildConfiguration: 'Release'
  buildPlatform: 'Any CPU'
  dotnet_version: '6.x.x'
  AZURE_WEBAPP_PACKAGE_PATH: '.'
  Azure_Resource_Group: 'MercuryHealth-rg'
  Website_Name: 'webSite-4vwxkvpofrtbq'
  Function_AppName: 'functionApp-4vwxkvpofrtbq'
  Hosting_Plan_Name: 'appPlan-4vwxkvpofrtbq'
  loadTestConfigFile: 'LoadTest_HomePage.jmx'
#  Deployment_Name: MercuryHealthGroup.${{ github.workflow }}.${{ github.run_number }}

###################################################################
# Triggers - Controls when the action will run.
###################################################################
on:
  # Triggers the workflow on push or pull request events but only for the master branch
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
# This workflow contains a multiple jobs: "CI", "Dev", "QA", "Prod"
###################################################################
# CI Stage 
###################################################################
jobs:
  Build_Stage_Application:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    name: Build Application
    
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      ###########################################
      # Build App
      ###########################################
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - name: Checkout
        uses: actions/checkout@v2

      - name: Setup .NET Core
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: ${{ env.dotnet_version }}

      # Run dotnet build and publish
      - name: dotnet build unit test and publish
        run: |
          dotnet restore
          dotnet build MercuryHealth.Web/MercuryHealth.Web.csproj --configuration ${{ env.buildConfiguration }} --no-restore
          dotnet publish MercuryHealth.Web/MercuryHealth.Web.csproj --configuration ${{ env.buildConfiguration }} -o './website'
          dotnet build MercuryHealth.UITests/MercuryHealth.UITests.csproj --configuration ${{ env.buildConfiguration }} --no-restore
          dotnet publish MercuryHealth.UITests/MercuryHealth.UITests.csproj --configuration ${{ env.buildConfiguration }} -o './uitests'
          dotnet build MercuryHealth.FunctionApp/MercuryHealth.FunctionApp.csproj --configuration ${{ env.buildConfiguration }} --no-restore
          dotnet publish MercuryHealth.FunctionApp/MercuryHealth.FunctionApp.csproj --configuration ${{ env.buildConfiguration }} -o './functionapp'
          dotnet build MercuryHealth.API/MercuryHealth.API.csproj --configuration ${{ env.buildConfiguration }} --no-restore
          dotnet publish MercuryHealth.API/MercuryHealth.API.csproj --configuration ${{ env.buildConfiguration }} -o './api'

      - name: dotnet retore database
        run: dotnet restore MercuryHealth.Database/MercuryHealth.Database.csproj
      - name: dotnet build database
        run: dotnet build MercuryHealth.Database/MercuryHealth.Database.csproj --configuration ${{ env.buildConfiguration }} --no-restore --output './database'

      ###########################################
      # Run Unit Tests
      ###########################################
      - name: dotnet run unit tests
        run: dotnet test MercuryHealth.UnitTests/MercuryHealth.UnitTests.csproj

      ###########################################
      # Upload Artifacts
      ###########################################
      - name: Upload Build Artifacts-Website
        if: ${{ github.event_name != 'pull_request' }}
        uses: actions/upload-artifact@v2
        with:
          name: MercuryHealth.Website
          path: ${{ github.workspace }}/website

      - name: Upload Build Artifacts-FunctionApp
        if: ${{ github.event_name != 'pull_request' }}
        uses: actions/upload-artifact@v2
        with:
          name: MercuryHealth.FunctionApp
          path: ${{ github.workspace }}/functionapp

      - name: Upload Build Artifacts-Database
        if: ${{ github.event_name != 'pull_request' }}
        uses: actions/upload-artifact@v2
        with:
          name: MercuryHealth.Database
          path: ${{ github.workspace }}/database

      - name: Upload Build Artifacts-API
        if: ${{ github.event_name != 'pull_request' }}
        uses: actions/upload-artifact@v2
        with:
          name: MercuryHealth.API
          path: ${{ github.workspace }}/api

      - name: Upload Build Artifacts-UI Tests
        if: ${{ github.event_name != 'pull_request' }}
        uses: actions/upload-artifact@v2
        with:
          name: MercuryHealth.UITests
          path: ${{ github.workspace }}/MercuryHealth.UITests/MercuryHealth.UITests.csproj

      - name: Upload Build Artifacts-UI Tests
        if: ${{ github.event_name != 'pull_request' }}
        uses: actions/upload-artifact@v2
        with:
          name: MercuryHealth.UITests
          path: ${{ github.workspace }}/uitests
          
      - name: Upload Infrastucture Files
        if: ${{ github.event_name != 'pull_request' }}
        uses: actions/upload-artifact@v2
        with:
          name: MercuryHealth.IaC
          path: ${{ github.workspace }}/MercuryHealth.IaC/*

      - name: "Azure login"
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      ###########################################
      # Validate ARM Template using Bicep DSL
      ###########################################
      - name: Validate Azure Bicep
        uses: Azure/arm-deploy@v1
        with:
          resourceGroupName: ${{ env.Azure_Resource_Group }}
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          template: ${{ github.workspace }}/MercuryHealth.IaC/main-1.bicep
          parameters: ${{ github.workspace }}/MercuryHealth.IaC/main-1.params.json sqlAdministratorLogin=${{ secrets.SQL_DB_LOGIN }} sqlAdministratorLoginPassword=${{ secrets.SQL_DB_PASSWORD }}
          deploymentMode: Validate

      - name: Azure logout
        run: |
          az logout

###################################################################
# CD Stage - Infrastructure                                       #
###################################################################
  Deploy_Stage_IaC:
    if: contains(github.event_name, 'push')

    name: Deploy Infrastructure
    
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Identify any jobs that must complete successfully before this job will run.
    needs: [Build_Stage_Application]
    steps:
    - name: Download Build Artifact-Infrastructure
      uses: actions/download-artifact@v2
      continue-on-error: false
      with:
        name: MercuryHealth.IaC
        path: ${{ github.workspace }}/MercuryHealth.IaC
        
    - name: Login to Azure
      uses: azure/login@v1
      continue-on-error: false
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      ###########################################
      # Validate ARM Template using Bicep DSL
      ###########################################
    - name: Deploy Infrastucture
      uses: azure/arm-deploy@v1
      with:
        subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION }}
        resourceGroupName: ${{ env.Azure_Resource_Group }}
        template: ./MercuryHealth.IaC/main-1.bicep
        parameters: ./MercuryHealth.IaC/main-1.params.json sqlAdministratorLogin=${{ secrets.SQL_DB_LOGIN }} sqlAdministratorLoginPassword=${{ secrets.SQL_DB_PASSWORD }}
        deploymentMode: Incremental
        failOnStdErr: false

    - name: Azure logout
      run: |
        az logout
        
###################################################################
# CD Stage - Deploy the Database
###################################################################
  Deploy_Stage_Database:
    if: contains(github.event_name, 'push')

    name: Deploy Database
    runs-on: windows-latest

    # Identify any jobs that must complete successfully before this job will run.
    needs: [Deploy_Stage_IaC]
    steps:

    - name: Download Build Artifact-Database
      uses: actions/download-artifact@v2
      continue-on-error: false
      with:
        name: MercuryHealth.Database
        path: ${{ github.workspace }}/MercuryHealth.Database

    - name: Login to Azure
      uses: azure/login@v1
      continue-on-error: false
      with:
        creds: ${{ secrets.AZURE_SQL_CREDENTIALS }}
    
    # Deploy Database *.dacpac file - Requires windows-latest runner!!!
    - name: 'Deploy the database to Azure'
      uses: Azure/sql-action@v1.2
      with:
        server-name: ${{ secrets.SQL_DB_Server_Name }}
        
        connection-string: ${{â€¯secrets.SQL_DB_Connection_String }}
        dacpac-package: './MercuryHealth.Database/MercuryHealth.Database.dacpac'

    - name: Azure logout
      run: |
        az logout

###################################################################
# CD Stage - Application                                             #
###################################################################
  Deploy_Stage_Application:
    if: contains(github.event_name, 'push')

    name: Deploy Application
    
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Identify any jobs that must complete successfully before this job will run.
    needs: [Deploy_Stage_IaC]
    
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:

    ###########################################
    # Download Artifacts
    ###########################################
    - name: Download Build Artifacts-Function Application
      uses: actions/download-artifact@v2
      continue-on-error: false
      with:
        name: MercuryHealth.FunctionApp
        path: ${{ github.workspace }}/MercuryHealth.FunctionApp

    - name: Download Build Artifacts-Website Applicationn
      uses: actions/download-artifact@v2
      continue-on-error: false
      with:
        name: MercuryHealth.Website
        path: ${{ github.workspace }}/MercuryHealth.Website
        
    - name: Login to Azure
      uses: azure/login@v1
      continue-on-error: false
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # Deploy Application
    - name: 'Deploy Website Application'
      uses: azure/webapps-deploy@v2
      with:
          app-name: ${{ env.Website_Name }}
          slot-name: 'Dev'
          package: './MercuryHealth.Website'
          
    # Deploy Function Application
    - name: 'Deploy Function Application'
      uses: Azure/functions-action@v1
      with:
        app-name: ${{ env.Function_AppName }}
        slot-name: 'production'
        package: './MercuryHealth.FunctionApp'
        
    # Deploy APIs
    - name: 'Deploy APIs'
      run: echo 'Deploy APIs'
#      uses: azure/webapps-deploy@v2
#      with:
#          app-name: ${{ env.Website_Name }}
#          slot-name: 'Dev'
#          package: './MercuryHealth.API'

    # Insert a deployment annotation into Application Insights
    - name: Annotate deployment
      uses: wictorwilen/application-insights-action@v1
      continue-on-error: true
      id: annotation
      with:
        applicationId: ${{ secrets.AppInsightsApplicationID }}
        apiKey: ${{secrets.AppInsightsDeployAnnotationAPIKey}}
        releaseName: ${{ github.event_name }}
        message: ${{ github.event.head_commit.message }}
        actor: ${{ github.actor }}
        continue-on-error: true
    
    - name: Azure logout
      run: |
        az logout

###################################################################
# CD Stage - UI Testing                         
###################################################################
  UITesting_Stage_Application:
    if: contains(github.event_name, 'push')

    name: Playwright UI Testing
    
    # The type of runner that the job will run on
    #runs-on: ubuntu-latest
    runs-on: windows-latest

    # Identify any jobs that must complete successfully before this job will run.
    needs: [Deploy_Stage_Application, Deploy_Stage_Database]
    timeout-minutes: 10
        
    steps:
      - name: Setup .NET Core
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: ${{ env.dotnet_version }}

      - name: Download Build Artifacts-Playwright Tests
        uses: actions/download-artifact@v2
        with:
          name: MercuryHealth.UITests
          path: ${{ github.workspace }}/MercuryHealth.UITests

      - name: Install Playwright
        continue-on-error: true
        run: |
          dotnet .\bin\Debug\net6.0\Microsoft.Playwright.dll -- install
          #dotnet tool install -g Microsoft.Playwright.CLI
          cd ${{ github.workspace }}/MercuryHealth.UITests
          npx playwright install
          #npx playwright install-deps chromium

      - name: Playwright Tests
        continue-on-error: true
        run: dotnet test MercuryHealth.UITests/MercuryHealth.UITests.dll --verbosity normal
      
       # note this step is needed because the latest chromium is not being installed with the above commands
      - name: Ensure latest Chromium
        run: npm i -D playwright

#      - name: Run Playwright tests (Linux)
#        continue-on-error: true
#        run: |
#          chmod -R 755 /home/runner/work/MercuryHealth/MercuryHealth/MercuryHealth.UITests
#          #chmod -R 755 /home/runner/work/MercuryHealth/MercuryHealth/MercuryHealth.UITests/.playwright/node/linux
#          #chmod +x /home/runner/work/MercuryHealth/MercuryHealth/MercuryHealth.UITests/.playwright/node/linux/playwright.sh
#          #chmod -R 755 /home/runner/work/MercuryHealth/MercuryHealth/MercuryHealth.UITests
#          #xvfb-run --auto-servernum --server-args="-screen 0 1280x960x24" -- bash -c "ulimit -c unlimited && dotnet test MercuryHealth.UITests/MercuryHealth.UITests.dll -f net60 --logger \"trx\""
#          dotnet test MercuryHealth.UITests/MercuryHealth.UITests.dll

  PlaywrightUITests_Stage_RunInContainer:
    if: contains(github.event_name, 'push')

    name: Playwright UI Testing (Container)
    runs-on: ubuntu-latest

    container: mcr.microsoft.com/playwright:focal

    needs: [Deploy_Stage_Application, Deploy_Stage_Database]
    timeout-minutes: 60
    
    steps:
    - uses: actions/checkout@v2
#    - run: printenv
    - run: echo "Demo - Add steps here..."
#    - run: sudo apt install docker-ce docker-ce-cli containerd.io
#    - run: sudo docker cp MercuryHealth.UITests.dll playwright:/MercuryHealth.UITests.dll

    - name: 2-Run Playwright Tests
      run: dotnet test MercuryHealth.UITests/MercuryHealth.UITests.dll
      continue-on-error: true
      
###################################################################
# CD Stage - Load and Performance Testing                         #
###################################################################
  LoadTesting_Stage_Application:
    if: contains(github.event_name, 'push')

    name: Load Test Application
    
    # Identify any jobs that must complete successfully before this job will run.
    runs-on: ubuntu-latest

    # Identify any jobs that must complete successfully before this job will run.
    needs: [UITesting_Stage_Application]
    steps:
      - name: Checkout GitHub Actions 
        uses: actions/checkout@v2
          
      - name: Login to Azure
        uses: azure/login@v1
        continue-on-error: true
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
        
      - name: 'Azure Load Testing'
        run: echo 'Azure Load Testing'
      
      - name: 'Azure Load Testing'
        uses: azure/load-testing@main
        with:
          loadTestConfigFile: 'SampleApp.yaml'
#          loadTestResource: ${{ env.LOAD_TEST_RESOURCE }}
          resourceGroup: ${{ env.Azure_Resource_Group }}

      - name: Azure logout
        run: |
          az logout
        
###################################################################
# CD Stage - Production                        #
###################################################################
  Production_Stage_Application:
    if: contains(github.event_name, 'push')

    name: Deploy to Production
    
    # Identify any jobs that must complete successfully before this job will run.
    runs-on: ubuntu-latest

    # Identify any jobs that must complete successfully before this job will run.
    needs: [LoadTesting_Stage_Application]
    environment: Production
    steps:
      - name: Checkout GitHub Actions 
        uses: actions/checkout@v2
          
      - name: Login to Azure
        uses: azure/login@v1
        continue-on-error: false
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
        
      # Swap deployment slots on App Service
      - name: 'Swap slots to Production'
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az webapp deployment slot swap \
              -g ${{ env.Azure_Resource_Group }} \
              -n ${{ env.Website_Name }} \
              --slot dev \
              --target-slot production      
              
      - name: Process errors
        if: ${{ failure() }}
        run: |
            curl --request POST \
              --url https://api.github.com/repos/${{ github.repository }}/issues \
              --header 'authorization: Bearer ${{ secrets.GITHUB_TOKEN }}' \
              --header 'content-type: application/json' \
              --data '{
                "title": "${{ env.script-name }} has failed: ${{ github.run_id }}",
                "body": "${{ env.script-name }} has failed: **${{ github.workflow }}**. \n\n Failure in run: _${{ github.run_id }}_."
                }'
